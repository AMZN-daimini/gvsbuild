From 75275683a2336d276befe56e3d2568c0532284ae Mon Sep 17 00:00:00 2001
From: Ignacio Casal Quinteiro <qignacio@amazon.com>
Date: Mon, 26 Aug 2019 17:05:02 +0200
Subject: [PATCH] WebSockets: fix invalid read when sending large messages

We use GByteArray, which can be reallocated, so be careful when
keeping track of the current position in a message not to use
potentially dangling pointers.

Fixes #160
---
 libsoup/soup-websocket-connection.c | 6 +++---
 1 file changed, 3 insertions(+), 3 deletions(-)

diff --git a/libsoup/soup-websocket-connection.c b/libsoup/soup-websocket-connection.c
index 35eee6a6..b0b0fb50 100644
--- a/libsoup/soup-websocket-connection.c
+++ b/libsoup/soup-websocket-connection.c
@@ -350,7 +350,7 @@ send_message (SoupWebsocketConnection *self,
 	gsize frame_len;
 	guint8 *outer;
 	guint8 *mask = 0;
-	guint8 *at;
+	guint at;
 
 	if (!(soup_websocket_connection_get_state (self) == SOUP_WEBSOCKET_STATE_OPEN)) {
 		g_debug ("Ignoring message since the connection is closed or is closing");
@@ -408,11 +408,11 @@ send_message (SoupWebsocketConnection *self,
 		bytes->len += 4;
 	}
 
-	at = bytes->data + bytes->len;
+	at = bytes->len;
 	g_byte_array_append (bytes, data, length);
 
 	if (self->pv->connection_type == SOUP_WEBSOCKET_CONNECTION_CLIENT)
-		xor_with_mask (mask, at, length);
+		xor_with_mask (mask, bytes->data + at, length);
 
 	frame_len = bytes->len;
 	queue_frame (self, flags, g_byte_array_free (bytes, FALSE),
-- 
2.17.1

